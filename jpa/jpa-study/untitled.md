# Untitled



스프링이나 J2EE 컨테이너 환경에서 JPA를 사용하면 컨테이너가 트랜잭션과 영속성 컨텍스트를 관리해주므로 애플리케이션을 손쉽게 개발할 수 있다.

JPA의 내부 동작 방식을 이해하지 못하면 문제가 발생했을 때 해결하기 쉽지 않다.

## Why?

### 트랜잭션 범위의 영속성 컨텍스트

순수하게 J2SE 환경에서 JPA를 사용하면 개발자가 직접 엔티티 매니저를 생성하고 트랜잭션도 관리해야 한다. 하지만 스프링이나 J2EE 컨테이너 환경에서 JPA를 사용하면 컨테이너가 제공하는 전략에 따라야 한다.

#### ? 컨테이너가 제공하는 전략은 무엇일까?

#### 스프링 컨테이너의 기본 전략

**스프링 컨테이너는 트랜잭션 범위의 영속성 컨텍스트 전략을 기본으로 사용한다.**

트랜잭션 범위의 영속성 컨텍스트 전략이란?

* 트랜잭션의 범위와 영속성 컨텍스트의 생존 범위가 같다는 뜻.
* 트랜잭션을 시작할 때 영속성 컨텍스트를 생성하고 트랜잭션이 끝날 때 영속성 컨텍스트를 종료한다. 
  * 트랜잭션이 같으면 같은 영속성 컨텍스트를 사용한다.
    * 다양한 위치에서 엔티티 매니저를 주입받아 사용해도 트랜잭션이 같으면 항상 같은 영속성 컨텍스트를 사용한다.
  * 트랜잭션이 다르면 다른 영속성 컨텍스트를 사용한다.
    * 여러 스레드에서 동시에 요청이 와서 같은 엔티티 매니저를 사용해도 트랜잭션에 따라 접근하는 영속성 컨텍스트가 다르다.
    * 즉 스프링 컨테이너는 스레드마다 각각 다른 트랜잭션을 할당한다. 따라서 같은 엔티티 매니저를 호출해도 접근하는 영속성 컨텍스트가 다르므로 멀티스레드 상황에 안전하다.

## 첫번째 이유 :

**트랜잭션과 복잡한 멀티 스레드 상황을 컨테이너가 처리해준다.**

이러한 이유로 개발자는 싱글 스레드 애플리케이션처럼 단순하게 개발할 수 있고 비지니스 로직 개발에 집중 할 수 있다.

&lt;그림 13.1&gt;

스프링 프레임워크를 사용하면 Service Layer에서 @Transactional 어노테이션을 선언해서 트랜잭션을 시작한다.

--&gt; @Transactional 어노테이션이 있으면 호출한 메소드를 실행하기 직전에 스프링의 트랜잭션 AOP가 먼저 동작한다.

## ? Transactional AOP?

&lt;그림 13.2&gt; 대상 메소드를 호출하기 직전에 트랜잭션을 시작하고, 대상 메소드가 정상 종료되면 트랜잭션을 커밋하면서 종료한다.

--&gt; 이때 트랜잭션을 커밋하면 JPA는 먼저 영속성 컨텍스트를 플러시해서 변경 내용을 데이터베이스에 반영한 후에 데이터베이스 트랜잭션을 커밋한다.

결과적으로 영속성 컨텍스트의 변경 내용이 데이터베이스에 정상 반영된다. 만약 예외가 발생하면 트랜잭션을 롤백하고 종료하는데 이때는 플러시를 호출하지 않는다.

## ? 플러시를 호출하지 않는다면 데이터베이스 반영까지 안간다는 말인가?

&lt;예제 13.1&gt;

## 준영속 상태와 지연 로딩

스프링 컨테이너를 이용하여 조회 된 엔티티는 서비스와 리포지토리 계층에서 영속성 컨텍스트에 관리되면서 영속 상태를 유지하지만 컨트롤러나 뷰 같은 프리젠테이션 계층에서는 준영속 상태\(트랜잭션이 종료되면서 영속성 컨텍스트도 함께 종료되었기 때문에 준영속 상태로 변환\)가 된다.

#### 준영속 상태

* 변경감지와 지연 로딩이 동작하지 않게된다.
  * 변경감지 : 영속성 컨텍스트가 살아 있는 서비스 계층\(트랜잭션 범위\)까지만 동작하고 영속성 컨텍스트가 종료된 프리젠테이션 계층에서는 동작하지 않는다.
  * 지연로딩 : 준영속성 상태에서는 지연 로딩 기능이 동작하지 않는다.
    * 그 이유는 바로 준영속성 상태는 영속성 컨텍스트가 없기 때문이다.
    * 해결법 : 뷰가 필요한 엔티티를 미리 로딩해두는법, OSIV를 사용해서 엔티티를 항상 영속 상태로 유지하는 방법

### 뷰가 필요한 엔티티를 미리 로딩해두는법

1. 글로벌 페치전략 수정 엔티티에 있는 fetch 타입을 지연로딩에서 즉시로딩으로 변경하는 방법.

   단점 :

   * 사용하지 않는 엔티티를 로딩한다.
   * N+1 문제가 발생한다.

2. JPQL 페치 조인
3. 강제로 초기화

